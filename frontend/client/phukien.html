<!-- Thanh t√¨m ki·∫øm -->
<div class="bg-white border-b border-gray-200 sticky top-0 z-20">
  <div
    class="px-4 py-3 mx-auto max-w-7xl sm:px-6 lg:px-8 flex items-center gap-3"
  >
    <input
      id="search-input"
      type="text"
      placeholder="üîç T√¨m ki·∫øm laptop..."
      class="flex-1 px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
    />
    <button
      id="search-btn"
      class="px-4 py-2 font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition"
    >
      T√¨m ki·∫øm
    </button>
  </div>
</div>

<!-- B·ªô l·ªçc + K·∫øt qu·∫£ -->
<section class="py-10 bg-gray-50">
  <div
    class="px-4 mx-auto max-w-7xl sm:px-6 lg:px-8 grid grid-cols-1 md:grid-cols-4 gap-8"
  >
    <!-- B·ªô l·ªçc -->
    <aside
      class="p-5 bg-white border border-gray-200 rounded-xl shadow-sm h-fit"
    >
      <h3 class="mb-8 text-xl font-semibold text-gray-800">B·ªô l·ªçc s·∫£n ph·∫©m</h3>

      <!-- H√£ng s·∫£n xu·∫•t -->
      <div class="border-b pb-5">
        <button
          class="flex justify-between items-center w-full group"
          data-toggle="collapse"
        >
          <h4 class="font-semibold text-gray-800">Ph·ª• ki·ªán</h4>
          <span class="transition-transform group-[data-open=true]:rotate-180"
            >‚ñº</span
          >
        </button>
        <div class="mt-5 space-y-2 hidden">
          <label
            ><input type="checkbox" class="accessory-filter" value="Balo" />
            Balo</label
          ><br />
          <label
            ><input type="checkbox" class="accessory-filter" value="Chu·ªôt" />
            Chu·ªôt</label
          ><br />
          <label
            ><input type="checkbox" class="accessory-filter" value="Tai nghe" />
            Tai nghe</label
          ><br />
          <label
            ><input type="checkbox" class="accessory-filter" value="B√†n Ph√≠m" />
            B√†n Ph√≠m</label
          ><br />
          <label
            ><input type="checkbox" class="accessory-filter" value="M√†n H√¨nh" />
            M√†n H√¨nh</label
          ><br />

          <br />
        </div>
      </div>

      <!-- M·ª©c gi√° -->
      <div class="border-b pb-5 mt-5">
        <button
          class="flex justify-between items-center w-full group"
          data-toggle="collapse"
        >
          <h4 class="font-semibold text-gray-800">M·ª©c gi√°</h4>
          <span class="transition-transform group-[data-open=true]:rotate-180"
            >‚ñº</span
          >
        </button>
        <div class="mt-3 hidden space-y-2">
          <label class="flex items-center gap-2">
            <input
              type="radio"
              name="price"
              class="price-filter"
              value="0-9999999999"
            />
            T·∫•t c·∫£
          </label>
          <label class="flex items-center gap-2">
            <input
              type="radio"
              name="price"
              class="price-filter"
              value="0-1000000"
            />
            D∆∞·ªõi 1 tri·ªáu
          </label>
          <label class="flex items-center gap-2">
            <input
              type="radio"
              name="price"
              class="price-filter"
              value="1000000-10000000"
            />
            1 - 10 tri·ªáu
          </label>
          <label class="flex items-center gap-2">
            <input
              type="radio"
              name="price"
              class="price-filter"
              value="10000000-999999999"
            />
            Tr√™n 10 tri·ªáu
          </label>
        </div>
      </div>
      <div class="border-b pb-5 mt-5">
        <button
          class="flex justify-between items-center w-full group"
          data-toggle="collapse"
        >
          <h4 class="font-semibold text-gray-800">H√£ng s·∫£n xu·∫•t</h4>
          <span class="transition-transform group-[data-open=true]:rotate-180"
            >‚ñº</span
          >
        </button>
        <div class="mt-5 space-y-2 hidden">
          <label class="flex items-center gap-2">
            <input type="checkbox" class="brand-filter" value="1" /> ASUS
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" class="brand-filter" value="2" /> ACER
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" class="brand-filter" value="3" /> LENOVO
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" class="brand-filter" value="4" /> APPLE
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" class="brand-filter" value="5" /> DELL
          </label>
        </div>
      </div>

      <!-- Reset -->
      <button
        id="clear-filter"
        class="w-full py-2 mt-4 text-sm font-medium text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition"
      >
        X√≥a b·ªô l·ªçc
      </button>
    </aside>

    <!-- Danh s√°ch s·∫£n ph·∫©m -->
    <div class="md:col-span-3">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">K·∫øt qu·∫£ t√¨m ki·∫øm</h2>
      <div
        class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3"
        id="product-list"
      ></div>
    </div>
  </div>
</section>

<script type="module">
  import { fetchWithTokenRetry } from "http://127.0.0.1:5501/frontend/js/authFetch.js";
  function selectProduct1(id) {
    localStorage.setItem("selectedProductId", id);
    loadPage("../client/detail_accessory.html");
  }
  function normalizeText(str) {
    return str
      ? str
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-z0-9\s]/g, "")
          .trim()
      : "";
  }

  document.querySelectorAll("[data-toggle='collapse']").forEach((btn) => {
    btn.addEventListener("click", () => {
      const panel = btn.nextElementSibling;
      const open = btn.dataset.open === "true";
      btn.dataset.open = !open;
      panel.classList.toggle("hidden", open);
    });
  });

  let allProducts = [];
  let filtered = [];
  let currentPage = 1;
  const itemsPerPage = 6;
  const productList = document.getElementById("product-list");
  // üß± Render t·ª´ng th·∫ª s·∫£n ph·∫©m
  function renderProductCard(product) {
    const param = product.id;
    const hasDiscount =
      product.discounted_price &&
      Number(product.discounted_price) < Number(product.price);

    // ƒê·ªãnh d·∫°ng gi√°
    const originalPrice = Number(product.price).toLocaleString("vi-VN") + "ƒë";
    const discountedPrice =
      Number(product.discounted_price).toLocaleString("vi-VN") + "ƒë";

    return `
    <div onclick="selectProduct1(${param})" 
         class="group bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-md transition p-3 cursor-pointer">
      
      <img src="${product.img || "https://via.placeholder.com/300"}"
           alt="${product.productName}"
           class="transition group-hover:scale-110 object-cover w-full h-48 rounded-md">
      
      <div class="mt-3 text-center">
        <h3 class="text-gray-900 font-semibold text-base mb-1 line-clamp-2">
          ${product.productName}
        </h3>
        
        ${
          hasDiscount
            ? `
              <div class="flex flex-col items-center">
                <span class="text-gray-400 line-through text-sm">
                  ${originalPrice}
                </span>
                <span class="text-red-600 font-bold text-lg">
                  ${discountedPrice}
                </span>
              </div>
            `
            : `
              <p class="text-blue-600 font-bold text-lg">
                ${originalPrice}
              </p>
            `
        }
      </div>

      <div class="mt-4 px-4 pb-4 text-center">
        <button onclick="event.stopPropagation(); addToCompare(${JSON.stringify(
          product
        ).replace(/"/g, "&quot;")}, 'accessory')" 
            class="flex items-center w-full gap-2 px-6 py-3 text-blue-500 transition-colors border-2 border-blue-500 rounded-lg hover:bg-blue-50">
          <i class="fas fa-exchange-alt"></i>
          <span>Th√™m v√†o so s√°nh</span>
        </button>
      </div>
    </div>
  `;
  }

  // üì¶ Render danh s√°ch c√≥ ph√¢n trang
  function renderProductsWithPagination(products) {
    const totalPages = Math.ceil(products.length / itemsPerPage);
    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const paginated = products.slice(start, end);

    renderProducts(paginated);
    renderPagination(totalPages);
  }

  // üß© Render s·∫£n ph·∫©m
  function renderProducts(products) {
    productList.innerHTML = products.length
      ? products.map(renderProductCard).join("")
      : '<p class="col-span-3 text-center text-gray-500">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o.</p>';
  }

  // üìÑ Render ph√¢n trang
  function renderPagination(totalPages) {
    const paginationContainer =
      document.getElementById("pagination") ||
      (() => {
        const div = document.createElement("div");
        div.id = "pagination";
        div.className = "flex justify-center mt-6 flex-wrap gap-2";
        productList.parentNode.appendChild(div);
        return div;
      })();

    paginationContainer.innerHTML = "";

    if (currentPage > 1) {
      const prev = document.createElement("button");
      prev.textContent = "¬´ Tr∆∞·ªõc";
      prev.className =
        "px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 transition";
      prev.addEventListener("click", () => {
        currentPage--;
        renderProductsWithPagination(filtered);
      });
      paginationContainer.appendChild(prev);
    }

    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;
      btn.className = `px-3 py-1 rounded ${
        i === currentPage
          ? "bg-blue-500 text-white"
          : "bg-gray-200 hover:bg-gray-300"
      } transition`;
      btn.addEventListener("click", () => {
        currentPage = i;
        renderProductsWithPagination(filtered);
      });
      paginationContainer.appendChild(btn);
    }

    if (currentPage < totalPages) {
      const next = document.createElement("button");
      next.textContent = "Sau ¬ª";
      next.className =
        "px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 transition";
      next.addEventListener("click", () => {
        currentPage++;
        renderProductsWithPagination(filtered);
      });
      paginationContainer.appendChild(next);
    }
  }

  // üéØ L·ªçc s·∫£n ph·∫©m
  function applyFilters() {
    filtered = [...allProducts];
    const keyword = normalizeText(
      document.getElementById("search-input").value
    );

    if (keyword) {
      filtered = filtered.filter((p) => {
        const name = normalizeText(p.productName);
        const des = normalizeText(p.accessory?.des);
        return name.includes(keyword) || des.includes(keyword);
      });
    }

    const selectedAccessory = [
      ...document.querySelectorAll(".accessory-filter:checked"),
    ].map((i) => normalizeText(i.value));

    if (selectedAccessory.length)
      filtered = filtered.filter((p) =>
        selectedAccessory.some((acc) =>
          normalizeText(p.productName || "").includes(acc)
        )
      );

    const priceRange = document.querySelector(".price-filter:checked")?.value;
    if (priceRange) {
      const [min, max] = priceRange.split("-").map(Number);
      filtered = filtered.filter(
        (p) => Number(p.price) >= min && Number(p.price) <= max
      );
    }

    const selectedBrandIds = [
      ...document.querySelectorAll(".brand-filter:checked"),
    ].map((i) => Number(i.value));
    if (selectedBrandIds.length)
      filtered = filtered.filter((p) =>
        selectedBrandIds.includes(Number(p.id_branch))
      );

    currentPage = 1;
    renderProductsWithPagination(filtered);
  }

  // üéõÔ∏è Event
  document.getElementById("search-btn").addEventListener("click", applyFilters);
  document
    .getElementById("search-input")
    .addEventListener("keypress", (e) => e.key === "Enter" && applyFilters());
  document
    .querySelectorAll("input")
    .forEach((el) => el.addEventListener("change", applyFilters));

  document.getElementById("clear-filter").addEventListener("click", () => {
    document
      .querySelectorAll("input[type=checkbox], input[type=radio]")
      .forEach((el) => (el.checked = false));
    document.getElementById("search-input").value = "";
    filtered = [...allProducts];
    currentPage = 1;
    renderProductsWithPagination(filtered);
  });

  // üîó Fetch API
  fetchWithTokenRetry("http://127.0.0.1:8000/api/products_mouse")
    .then((res) => res.json())
    .then((data) => {
      allProducts = data.data || [];
      filtered = [...allProducts];
      renderProductsWithPagination(filtered);
    })
    .catch((err) => console.error("L·ªói khi t·∫£i s·∫£n ph·∫©m:", err));
</script>
