<!-- Thanh t√¨m ki·∫øm -->
<div class="bg-white border-b border-gray-200 sticky top-0 z-20">
  <div
    class="px-4 py-3 mx-auto max-w-7xl sm:px-6 lg:px-8 flex items-center gap-3"
  >
    <input
      id="search-input"
      type="text"
      placeholder="üîç T√¨m ki·∫øm laptop..."
      class="flex-1 px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
    />
    <button
      id="search-btn"
      class="px-4 py-2 font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition"
    >
      T√¨m ki·∫øm
    </button>
  </div>
</div>

<!-- B·ªô l·ªçc + K·∫øt qu·∫£ -->
<section class="py-10 bg-gray-50">
  <div
    class="px-4 mx-auto max-w-7xl sm:px-6 lg:px-8 grid grid-cols-1 md:grid-cols-4 gap-8"
  >
    <!-- B·ªô l·ªçc -->
    <aside
      class="p-5 bg-white border border-gray-200 rounded-xl shadow-sm h-fit"
    >
      <h3 class="mb-8 text-xl font-semibold text-gray-800">B·ªô l·ªçc s·∫£n ph·∫©m</h3>

      <!-- H√£ng s·∫£n xu·∫•t -->
      <div class="border-b pb-3">
        <button
          class="flex justify-between items-center w-full group"
          data-toggle="collapse"
        >
          <h4 class="font-semibold text-gray-800">H√£ng s·∫£n xu·∫•t</h4>
          <span class="transition-transform group-[data-open=true]:rotate-180"
            >‚ñº</span
          >
        </button>
        <div class="mt-3 space-y-2 hidden">
          <label class="flex items-center gap-2">
            <input type="checkbox" class="brand-filter" value="1" /> ASUS
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" class="brand-filter" value="2" /> ACER
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" class="brand-filter" value="3" /> LENOVO
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" class="brand-filter" value="4" /> APPLE
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" class="brand-filter" value="5" /> DELL
          </label>
        </div>
      </div>

      <!-- M·ª©c gi√° -->
      <div class="border-b pb-3 mt-3">
        <button
          class="flex justify-between items-center w-full group"
          data-toggle="collapse"
        >
          <h4 class="font-semibold text-gray-800">M·ª©c gi√°</h4>
          <span class="transition-transform group-[data-open=true]:rotate-180"
            >‚ñº</span
          >
        </button>
        <div class="mt-3 hidden space-y-2">
               <label class="flex items-center gap-2">
            <input
              type="radio"
              name="price"
              class="price-filter"
              value="0-9999999999"
            />
           T·∫•t c·∫£
          </label>
          <label class="flex items-center gap-2">
            <input
              type="radio"
              name="price"
              class="price-filter"
              value="0-15000000"
            />
            D∆∞·ªõi 15 tri·ªáu
          </label>
          <label class="flex items-center gap-2">
            <input
              type="radio"
              name="price"
              class="price-filter"
              value="15000000-25000000"
            />
            15 - 25 tri·ªáu
          </label>
          <label class="flex items-center gap-2">
            <input
              type="radio"
              name="price"
              class="price-filter"
              value="25000000-999999999"
            />
            Tr√™n 25 tri·ªáu
          </label>
        </div>
      </div>

      <!-- CPU -->
      <div class="border-b pb-3 mt-3">
        <button
          class="flex justify-between items-center w-full group"
          data-toggle="collapse"
        >
          <h4 class="font-semibold text-gray-800">CPU</h4>
          <span class="transition-transform group-[data-open=true]:rotate-180"
            >‚ñº</span
          >
        </button>
        <div class="mt-3 space-y-2 hidden">
          <label class="flex items-center gap-2">
            <input type="checkbox" class="cpu-filter" value="i5" /> Intel Core
            i5
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" class="cpu-filter" value="i7" /> Intel Core
            i7
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" class="cpu-filter" value="AMD Ryzen" /> AMD
            Ryzen 
          </label>
           <label class="flex items-center gap-2">
            <input type="checkbox" class="cpu-filter" value="Apple" /> 
            Apple  
          </label>
        </div>
      </div>

      <!-- RAM -->
      <div class="border-b pb-3 mt-3">
        <button
          class="flex justify-between items-center w-full group"
          data-toggle="collapse"
        >
          <h4 class="font-semibold text-gray-800">RAM</h4>
          <span class="transition-transform group-[data-open=true]:rotate-180"
            >‚ñº</span
          >
        </button>
        <div class="grid grid-cols-1 gap-2 mt-3 hidden">
          <label class="flex items-center gap-2">
            <input type="checkbox" class="ram-filter" value="8GB" /> 8GB
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" class="ram-filter" value="16GB" /> 16GB
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" class="ram-filter" value="32GB" /> 32GB
          </label>
        </div>
      </div>
            <!-- Screen -->

        <div class="border-b pb-3 mt-3">
        <button
          class="flex justify-between items-center w-full group"
          data-toggle="collapse"
        >
          <h4 class="font-semibold text-gray-800">M√†n h√¨nh</h4>
          <span class="transition-transform group-[data-open=true]:rotate-180"
            >‚ñº</span
          >
        </button>
        <div class="grid grid-cols-1 gap-2 mt-3 hidden">
          <label class="flex items-center gap-2">
      <input type="checkbox" class="screen-filter" value="15.6 inch" /> 15.6 inch
    </label>
    <label class="flex items-center gap-2">
      <input type="checkbox" class="screen-filter" value="16 inch" /> 16 inch
    </label>
    <label class="flex items-center gap-2">
      <input type="checkbox" class="screen-filter" value="14 inch" /> 14 inch
    </label>
        </div>
              <!-- GPU -->

        <div class="border-b pb-3 mt-3">
        <button
          class="flex justify-between items-center w-full group"
          data-toggle="collapse"
        >
          <h4 class="font-semibold text-gray-800">GPU</h4>
          <span class="transition-transform group-[data-open=true]:rotate-180"
            >‚ñº</span
          >
        </button>
        <div class="grid grid-cols-1 gap-2 mt-3 hidden">
          <label class="flex items-center gap-2">
      <input type="checkbox" class="gpu-filter" value="RTX 3050" /> RTX 3050
    </label>
    <label class="flex items-center gap-2">
      <input type="checkbox" class="gpu-filter" value="RTX 4050" /> RTX 4050
    </label>
    <label class="flex items-center gap-2">
      <input type="checkbox" class="gpu-filter" value="RTX 4060" /> RTX 4060
    </label>
    <label class="flex items-center gap-2">
      <input type="checkbox" class="gpu-filter" value="RTX 4070" /> RTX 4070
    </label>
        </div>
      </div>

      <!-- Reset -->
      <button
        id="clear-filter"
        class="w-full py-2 mt-4 text-sm font-medium text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition"
      >
        X√≥a b·ªô l·ªçc
      </button>
    </aside>

    <!-- Danh s√°ch s·∫£n ph·∫©m -->
    <div class="md:col-span-3">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">K·∫øt qu·∫£ t√¨m ki·∫øm</h2>
      <div
        class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3"
        id="product-list"
      ></div>
    </div>
  </div>
</section>


<script type="module">
    function selectProduct(id) {
    localStorage.setItem("selectedProductId", id);
    loadPage("../client/detail_laptop.html");
  }
  import { fetchWithTokenRetry } from "http://127.0.0.1:5501/frontend/js/authFetch.js";

  function normalizeText(str) {
    return str
      ? str
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-z0-9\s]/g, "")
          .trim()
      : "";
  }

  document.querySelectorAll("[data-toggle='collapse']").forEach((btn) => {
    btn.addEventListener("click", () => {
      const panel = btn.nextElementSibling;
      const open = btn.dataset.open === "true";
      btn.dataset.open = !open;
      panel.classList.toggle("hidden", open);
    });
  });

  let allProducts = [];
  let filtered = [];
  let currentPage = 1;
  const itemsPerPage = 6;

  const productList = document.getElementById("product-list");

  // üß± Render t·ª´ng th·∫ª s·∫£n ph·∫©m
  function renderProductCard(product) {
     const param = product.id;
    return `
      <div onclick="selectProduct(${param})" class="group bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-md transition p-3 cursor-pointer">
        <img src="${product.img || "https://via.placeholder.com/300"}"
             alt="${product.productName}"
             class="transition group-hover:scale-110 object-cover w-full h-48 rounded-md">
        <div class="mt-3">
          <h3 class="text-gray-900 font-semibold text-base mb-1 line-clamp-2">${
            product.productName
          }</h3>
          <p class="text-blue-600 font-bold text-lg text-center">
            ${Number(product.price).toLocaleString("vi-VN")}ƒë
          </p>
        </div>
        <div class="mt-4 px-4 pb-4 text-center">
          <button onclick="event.stopPropagation(); addToCompare(${JSON.stringify(
            product
          ).replace(/"/g, "&quot;")}, 'accessory')" 
              class="flex items-center w-full gap-2 px-6 py-3 text-blue-500 transition-colors border-2 border-blue-500 rounded-lg hover:bg-blue-50">
            <i class="fas fa-exchange-alt"></i>
            <span>Th√™m v√†o so s√°nh</span>
          </button>
        </div>
      </div>`;
  }

  // üß© Render danh s√°ch s·∫£n ph·∫©m (c√≥ ph√¢n trang)
  function renderProductsWithPagination(products) {
    const totalPages = Math.ceil(products.length / itemsPerPage);
    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const paginated = products.slice(start, end);

    renderProducts(paginated);
    renderPagination(totalPages);
  }

  // üß≠ Render danh s√°ch s·∫£n ph·∫©m
  function renderProducts(products) {
    productList.innerHTML = products.length
      ? products.map(renderProductCard).join("")
      : '<p class="col-span-3 text-center text-gray-500">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o.</p>';
  }

  // üìÑ T·∫°o n√∫t ph√¢n trang
  function renderPagination(totalPages) {
    const paginationContainer =
      document.getElementById("pagination") ||
      (() => {
        const div = document.createElement("div");
        div.id = "pagination";
        div.className = "flex justify-center mt-6 flex-wrap gap-2";
        productList.parentNode.appendChild(div);
        return div;
      })();

    paginationContainer.innerHTML = "";

    // n√∫t Tr∆∞·ªõc
    if (currentPage > 1) {
      const prev = document.createElement("button");
      prev.textContent = "¬´ Tr∆∞·ªõc";
      prev.className =
        "px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 transition";
      prev.addEventListener("click", () => {
        currentPage--;
        renderProductsWithPagination(filtered);
      });
      paginationContainer.appendChild(prev);
    }

    // n√∫t s·ªë trang
    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;
      btn.className = `px-3 py-1 rounded ${
        i === currentPage
          ? "bg-blue-500 text-white"
          : "bg-gray-200 hover:bg-gray-300"
      } transition`;
      btn.addEventListener("click", () => {
        currentPage = i;
        renderProductsWithPagination(filtered);
      });
      paginationContainer.appendChild(btn);
    }

    // n√∫t Sau
    if (currentPage < totalPages) {
      const next = document.createElement("button");
      next.textContent = "Sau ¬ª";
      next.className =
        "px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 transition";
      next.addEventListener("click", () => {
        currentPage++;
        renderProductsWithPagination(filtered);
      });
      paginationContainer.appendChild(next);
    }
  }

  // üéØ √Åp d·ª•ng l·ªçc
  function applyFilters() {
    filtered = [...allProducts];
    const keyword = normalizeText(
      document.getElementById("search-input").value
    );

    // üîç T√¨m ki·∫øm
    if (keyword) {
      filtered = filtered.filter((p) => {
        const name = normalizeText(p.productName);
        const cpu = normalizeText(p.laptop?.CPU);
        const ram = normalizeText(p.laptop?.RAM);
        const gpu = normalizeText(p.laptop?.GPU);
        const screen = normalizeText(p.laptop?.screenSpecs);
        return (
          name.includes(keyword) ||
          cpu.includes(keyword) ||
          ram.includes(keyword) ||
          screen.includes(keyword) ||
          gpu.includes(keyword)
        );
      });
    }

    // üè∑Ô∏è H√£ng
    const selectedBrandIds = [
      ...document.querySelectorAll(".brand-filter:checked"),
    ].map((i) => Number(i.value));
    if (selectedBrandIds.length)
      filtered = filtered.filter((p) =>
        selectedBrandIds.includes(Number(p.id_branch))
      );

    // üí∞ Gi√°
    const priceRange = document.querySelector(".price-filter:checked")?.value;
    if (priceRange) {
      const [min, max] = priceRange.split("-").map(Number);
      filtered = filtered.filter(
        (p) => Number(p.price) >= min && Number(p.price) <= max
      );
    }

    // ‚öôÔ∏è CPU
    const selectedCPU = [
      ...document.querySelectorAll(".cpu-filter:checked"),
    ].map((i) => normalizeText(i.value));
    if (selectedCPU.length)
      filtered = filtered.filter((p) => {
        const cpu = normalizeText(p.laptop?.CPU);
        return selectedCPU.some((c) => cpu.includes(c));
      });

    // üß† RAM
    const selectedRAM = [
      ...document.querySelectorAll(".ram-filter:checked"),
    ].map((i) => normalizeText(i.value));
    if (selectedRAM.length)
      filtered = filtered.filter((p) => {
        const ramText = normalizeText(p.laptop?.RAM || "");
        return selectedRAM.some((r) => ramText.includes(r));
      });

    // üéÆ GPU
    const selectedGPU = [
      ...document.querySelectorAll(".gpu-filter:checked"),
    ].map((i) => normalizeText(i.value));
    if (selectedGPU.length)
      filtered = filtered.filter((p) => {
        const gpuText = normalizeText(p.laptop?.GPU || "");
        return selectedGPU.some((g) => gpuText.includes(g));
      });

    // üíª M√†n h√¨nh
    const selectedScreen = [
      ...document.querySelectorAll(".screen-filter:checked"),
    ].map((i) => normalizeText(i.value));
    if (selectedScreen.length)
      filtered = filtered.filter((p) => {
        const screenText = normalizeText(p.laptop?.screenSpecs || "");
        return selectedScreen.some((s) => screenText.includes(s));
      });

    // lu√¥n quay l·∫°i trang ƒë·∫ßu
    currentPage = 1;
    renderProductsWithPagination(filtered);
  }

  // üéõÔ∏è S·ª± ki·ªán
  document.getElementById("search-btn").addEventListener("click", applyFilters);
  document
    .getElementById("search-input")
    .addEventListener("keypress", (e) => e.key === "Enter" && applyFilters());
  document
    .querySelectorAll("input")
    .forEach((el) => el.addEventListener("change", applyFilters));

  document.getElementById("clear-filter").addEventListener("click", () => {
    document
      .querySelectorAll("input[type=checkbox], input[type=radio]")
      .forEach((el) => (el.checked = false));
    document.getElementById("search-input").value = "";
    filtered = [...allProducts];
    currentPage = 1;
    renderProductsWithPagination(filtered);
  });

  // üß© G·ªçi API
  fetchWithTokenRetry("http://127.0.0.1:8000/api/products_client")
    .then((res) => res.json())
    .then((data) => {
      allProducts = data.data || [];
      filtered = [...allProducts];
      renderProductsWithPagination(filtered);
    })
    .catch((err) => console.error("L·ªói khi t·∫£i s·∫£n ph·∫©m:", err));
</script>

