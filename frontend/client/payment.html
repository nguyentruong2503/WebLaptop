<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thanh to√°n ƒë∆°n h√†ng</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#6366f1",
              secondary: "#8b5cf6",
            },
          },
        },
      };
    </script>
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background: linear-gradient(135deg, #f0f4ff 0%, #e6e9ff 100%);
      }
      .card-shadow {
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }
      .product-card {
        transition: all 0.3s ease;
      }
      .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }
    </style>
  </head>
  <body class="min-h-screen">
    <div class="max-w-6xl mx-auto px-4 py-8">
      <!-- Header -->
      <header class="flex justify-between items-center mb-12">
        <div class="flex items-center">
          <div
            class="w-10 h-10 rounded-lg bg-gradient-to-r from-primary to-secondary flex items-center justify-center mr-3"
          >
            <i data-feather="shopping-bag" class="text-white"></i>
          </div>
          <h1 class="text-2xl font-bold text-gray-800">HQLap</h1>
        </div>
        <div class="flex items-center space-x-4">
          <button class="flex items-center text-gray-600 hover:text-primary">
            <i data-feather="help-circle" class="mr-1"></i>
            <span>Tr·ª£ gi√∫p</span>
          </button>
          <button class="flex items-center text-gray-600 hover:text-primary">
            <i data-feather="phone" class="mr-1"></i>
            <span>Li√™n h·ªá</span>
          </button>
        </div>
      </header>

      <div class="flex flex-col lg:flex-row gap-8">
        <div class="lg:w-2/3">
          <div class="bg-white rounded-2xl card-shadow p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-6">
              T√≥m t·∫Øt ƒë∆°n h√†ng
            </h2>

            <div class="space-y-6">
              <div class="product-card bg-gray-50 rounded-xl p-4 flex">
                <img
                  src="http://static.photos/technology/320x240/1"
                  alt="S·∫£n ph·∫©m"
                  class="w-24 h-24 object-cover rounded-lg"
                />
                <div class="ml-4 flex-1">
                  <h3 class="font-semibold text-gray-800">
                    Tai nghe Bluetooth kh√¥ng d√¢y
                  </h3>
                  <p class="text-gray-600 text-sm">M√†u: ƒêen | K√≠ch c·ª°: M</p>
                  <div class="flex justify-between items-center mt-3">
                    <div
                      class="flex items-center border border-gray-300 rounded-lg"
                    >
                      <button class="px-3 py-1 text-gray-600 hover:bg-gray-100">
                        -
                      </button>
                      <span class="px-3 py-1">1</span>
                      <button class="px-3 py-1 text-gray-600 hover:bg-gray-100">
                        +
                      </button>
                    </div>
                    <p class="font-bold text-gray-800">$129.99</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Shipping Information -->
          <div class="bg-white rounded-2xl card-shadow p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-6">
              Th√¥ng tin giao h√†ng
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-gray-700 text-sm font-medium mb-2"
                  >H·ªç v√† t√™n</label
                >
                <input
                  type="text"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                  placeholder="T√™n ng∆∞·ªùi nh·∫≠n"
                />
              </div>

              <div>
                <label class="block text-gray-700 text-sm font-medium mb-2"
                  >S·ªë ƒëi·ªán tho·∫°i</label
                >
                <input
                  type="tel"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                  placeholder="S·ªë ƒëi·ªán tho·∫°i"
                />
              </div>

              <div>
                <label class="block text-gray-700 text-sm font-medium mb-2"
                  >T·ªânh / Th√†nh ph·ªë</label
                >
                <select
                  id="city"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                >
                  <option value="">-- Ch·ªçn t·ªânh / th√†nh ph·ªë --</option>
                </select>
              </div>

              <div>
                <label class="block text-gray-700 text-sm font-medium mb-2"
                  >Qu·∫≠n / Huy·ªán</label
                >
                <select
                  id="district"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                  disabled
                >
                  <option value="">-- Ch·ªçn qu·∫≠n / huy·ªán --</option>
                </select>
              </div>

              <div>
                <label class="block text-gray-700 text-sm font-medium mb-2"
                  >Ph∆∞·ªùng / X√£</label
                >
                <select
                  id="ward"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                  disabled
                >
                  <option value="">-- Ch·ªçn ph∆∞·ªùng / x√£ --</option>
                </select>
              </div>

              <div class="md:col-span-2">
                <label class="block text-gray-700 text-sm font-medium mb-2"
                  >ƒê·ªãa ch·ªâ c·ª• th·ªÉ</label
                >
                <textarea
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                  rows="1"
                  placeholder="S·ªë nh√† ho·∫∑c t√™n t√≤a nh√†"
                ></textarea>
              </div>

              <div class="md:col-span-2">
                <label class="block text-gray-700 text-sm font-medium mb-2"
                  >Ghi ch√∫ giao h√†ng (Kh√¥ng b·∫Øt bu·ªôc)</label
                >
                <textarea
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                  rows="3"
                  placeholder="V√≠ d·ª•: G·ªçi tr∆∞·ªõc khi giao..."
                ></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column - Payment Summary -->
        <div class="lg:w-1/3">
          <div class="bg-white rounded-2xl card-shadow p-6 sticky top-8">
            <h2 class="text-xl font-bold text-gray-800 mb-6">
              Th√¥ng tin thanh to√°n
            </h2>

            <div class="space-y-4 mb-6">
              <div class="flex justify-between">
                <span class="text-gray-600">T·∫°m t√≠nh</span>
                <span class="font-medium">$379.98</span>
              </div>

              <div class="flex justify-between">
                <span class="text-gray-600">Ph√≠ giao h√†ng</span>
                <span class="font-medium">Mi·ªÖn ph√≠</span>
              </div>

              <div class="flex justify-between pt-4 border-t border-gray-200">
                <span class="text-lg font-bold text-gray-800">T·ªïng c·ªông</span>
                <span class="text-lg font-bold text-primary">$410.38</span>
              </div>
            </div>

            <!-- <div class="mb-6">
              <h3 class="font-medium text-gray-800 mb-3">M√£ gi·∫£m gi√°</h3>
              <div class="flex">
                <input
                  type="text"
                  id="discount_code"
                  name="no_autofill_discount"
                  autocomplete="new-password"
                  class="flex-1 px-4 py-3 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                  placeholder="Nh·∫≠p m√£ gi·∫£m gi√°"
                />
                <button
                  class="bg-gray-200 hover:bg-gray-300 px-4 rounded-r-lg font-medium"
                >
                  √Åp d·ª•ng
                </button>
              </div>
            </div> -->

            <!-- Payment Methods -->
            <div class="mb-6">
              <h3 class="font-medium text-gray-800 mb-3">
                Ph∆∞∆°ng th·ª©c thanh to√°n
              </h3>
              <div class="space-y-3">
                <div
                  class="flex items-center border border-gray-300 rounded-lg p-4 cursor-pointer hover:bg-gray-50"
                >
                  <input
                    type="radio"
                    name="payment"
                    id="cod"
                    class="mr-3"
                    checked
                  />
                  <label for="cod" class="flex-1 cursor-pointer">
                    <div class="flex items-center">
                      <i data-feather="truck" class="mr-2 text-gray-600"></i>
                      <span>Thanh to√°n khi nh·∫≠n h√†ng</span>
                    </div>
                  </label>
                </div>

                <div
                  class="flex items-center border border-gray-300 rounded-lg p-4 cursor-pointer hover:bg-gray-50"
                >
                  <input type="radio" name="payment" id="vnpay" class="mr-3" />
                  <label for="vnpay" class="flex-1 cursor-pointer">
                    <div class="flex items-center">
                      <i
                        data-feather="credit-card"
                        class="mr-2 text-gray-600"
                      ></i>
                      <span>Thanh to√°n qua VNPay</span>
                    </div>
                  </label>
                </div>
              </div>
            </div>

            <!-- VNPay Form -->
            <div id="vnpay-form" class="mb-6 bg-gray-50 rounded-lg p-4 hidden">
              <div class="grid grid-cols-1 gap-4">
                <div>
                  <label class="block text-gray-700 text-sm font-medium mb-2"
                    >T√†i kho·∫£n VNPay</label
                  >
                  <input
                    type="text"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                    placeholder="Nh·∫≠p t√†i kho·∫£n VNPay c·ªßa b·∫°n"
                  />
                </div>

                <div>
                  <label class="block text-gray-700 text-sm font-medium mb-2"
                    >M·∫≠t kh·∫©u</label
                  >
                  <input
                    type="password"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                    placeholder="Nh·∫≠p m·∫≠t kh·∫©u"
                  />
                </div>
              </div>
            </div>

            <button
              id="btnCheckout"
              class="w-full bg-gradient-to-r from-primary to-secondary text-white font-bold py-4 rounded-lg hover:opacity-90 transition duration-300 mb-4"
            >
              Ho√†n t·∫•t thanh to√°n
            </button>
          </div>

          <!-- Need Help -->
          <div
            class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl card-shadow p-6 mt-6"
          >
            <h3 class="font-bold text-gray-800 mb-3">C·∫ßn h·ªó tr·ª£?</h3>
            <p class="text-gray-600 text-sm mb-4">
              ƒê·ªôi ng≈© h·ªó tr·ª£ kh√°ch h√†ng c·ªßa ch√∫ng t√¥i s·∫µn s√†ng 24/7 ƒë·ªÉ gi√∫p b·∫°n.
            </p>
            <button class="flex items-center text-primary font-medium">
              <i data-feather="message-circle" class="mr-2"></i>
              Li√™n h·ªá h·ªó tr·ª£
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      feather.replace();

      document.addEventListener("DOMContentLoaded", () => {
        const items = JSON.parse(localStorage.getItem("checkoutItems") || "[]");
        const productContainer = document.querySelector(".space-y-6");
        const summarySection = document.querySelector(".space-y-4.mb-6");

        if (items.length === 0) {
          productContainer.innerHTML = `
        <p class="text-center text-gray-600">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c ch·ªçn ƒë·ªÉ thanh to√°n.</p>
      `;
          return;
        }

        // X√≥a n·ªôi dung c≈©
        productContainer.innerHTML = "";

        // Render t·ª´ng s·∫£n ph·∫©m
        let subtotal = 0;
        items.forEach((item) => {
          subtotal += item.price * item.quantity;

          const div = document.createElement("div");
          div.className = "product-card bg-gray-50 rounded-xl p-4 flex";

          div.innerHTML = `
        <img src="${item.image}" alt="${item.name}"
          class="w-24 h-24 object-cover rounded-lg" />
        <div class="ml-4 flex-1">
          <h3 class="font-semibold text-gray-800">${item.name}</h3>
          <p class="text-gray-600 text-sm">S·ªë l∆∞·ª£ng: ${item.quantity}</p>
          <div class="flex justify-between items-center mt-3">
            <span class="text-gray-600 text-sm">ƒê∆°n gi√°:</span>
            <p class="font-bold text-gray-800">${item.price.toLocaleString()} ‚Ç´</p>
          </div>
        </div>
      `;
          productContainer.appendChild(div);
        });

        const total = subtotal;

        summarySection.innerHTML = `
      <div class="flex justify-between">
        <span class="text-gray-600">T·∫°m t√≠nh</span>
        <span class="font-medium">${subtotal.toLocaleString()} ‚Ç´</span>
      </div>
      <div class="flex justify-between">
        <span class="text-gray-600">Ph√≠ giao h√†ng</span>
        <span class="font-medium">Mi·ªÖn ph√≠</span>
      </div>
      <div class="flex justify-between pt-4 border-t border-gray-200">
        <span class="text-lg font-bold text-gray-800">T·ªïng c·ªông</span>
        <span class="text-lg font-bold text-primary">${total.toLocaleString()} ‚Ç´</span>
      </div>
    `;
      });

      document
        .getElementById("btnCheckout")
        .addEventListener("click", async () => {
          const selectedPayment = document.querySelector(
            'input[name="payment"]:checked'
          ).id;

          const items = JSON.parse(
            localStorage.getItem("checkoutItems") || "[]"
          );
          if (items.length === 0) {
            alert("Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ƒë·ªÉ thanh to√°n.");
            return;
          }

          //debug
          console.log("üõí S·∫£n ph·∫©m thanh to√°n:", items);
          console.log(
            "üÜî Danh s√°ch product_ids:",
            items.map((i) => i.id)
          );

          const subtotal = items.reduce(
            (sum, item) => sum + item.price * item.quantity,
            0
          );
          const tax = subtotal * 0.08;
          const total = subtotal + tax;

          const btn = document.getElementById("btnCheckout");
          btn.disabled = true;
          btn.textContent = "ƒêang kh·ªüi t·∫°o thanh to√°n...";

          try {
            const token =
              localStorage.getItem("token") || sessionStorage.getItem("token");

            const name = document
              .querySelector('input[type="text"]')
              .value.trim();
            const phone = document
              .querySelector('input[type="tel"]')
              .value.trim();
            const addressDetail = document
              .querySelector("textarea[placeholder='S·ªë nh√† ho·∫∑c t√™n t√≤a nh√†']")
              .value.trim();

            const city =
              document.querySelector("#city option:checked")?.textContent || "";
            const district =
              document.querySelector("#district option:checked")?.textContent ||
              "";
            const ward =
              document.querySelector("#ward option:checked")?.textContent || "";

            const fullAddress = `${addressDetail}, ${ward}, ${district}, ${city}`;

            // ‚öôÔ∏è N·∫øu ch·ªçn VNPay
            if (selectedPayment === "vnpay") {
              const res = await fetch(
                "http://127.0.0.1:8000/api/payment/vnpay",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    ...(token ? { Authorization: `Bearer ${token}` } : {}),
                  },
                  body: JSON.stringify({
                    amount: total,
                    order_id: Date.now(),
                    bank_code: "NCB",
                    name: name,
                    phone: phone,
                    address: fullAddress,
                    product_ids: items.map((item) => item.id),
                  }),
                }
              );

              const data = await res.json();

              if (res.ok && data.payment_url) {
                window.location.href = data.payment_url;
              } else {
                console.error("VNPay API error:", data);
                alert(
                  "Kh√¥ng th·ªÉ t·∫°o li√™n k·∫øt thanh to√°n VNPay. Vui l√≤ng th·ª≠ l·∫°i."
                );
              }
            }

            // üíµ N·∫øu ch·ªçn COD
            else if (selectedPayment === "cod") {
              alert("ƒê·∫∑t h√†ng th√†nh c√¥ng! Vui l√≤ng thanh to√°n khi nh·∫≠n h√†ng.");
              // üëâ C√≥ th·ªÉ redirect v·ªÅ trang 'order.html'
              window.location.href = "/order.html";
            }
          } catch (error) {
            console.error("L·ªói khi g·ªçi VNPay API:", error);
            alert("C√≥ l·ªói x·∫£y ra khi kh·ªüi t·∫°o thanh to√°n VNPay.");
          } finally {
            btn.disabled = false;
            btn.textContent = "Ho√†n t·∫•t thanh to√°n";
          }
        });
    </script>

    <script>
      const citySelect = document.getElementById("city");
      const districtSelect = document.getElementById("district");
      const wardSelect = document.getElementById("ward");

      // üèôÔ∏è L·∫•y danh s√°ch t·ªânh / th√†nh
      fetch("https://provinces.open-api.vn/api/p/")
        .then((res) => res.json())
        .then((cities) => {
          cities.forEach((city) => {
            const option = document.createElement("option");
            option.value = city.code;
            option.textContent = city.name;
            citySelect.appendChild(option);
          });
        });

      // üèòÔ∏è Khi ch·ªçn t·ªânh -> load qu·∫≠n / huy·ªán
      citySelect.addEventListener("change", () => {
        const cityCode = citySelect.value;
        districtSelect.innerHTML =
          '<option value="">-- Ch·ªçn qu·∫≠n / huy·ªán --</option>';
        wardSelect.innerHTML =
          '<option value="">-- Ch·ªçn ph∆∞·ªùng / x√£ --</option>';
        wardSelect.disabled = true;

        if (cityCode) {
          fetch(`https://provinces.open-api.vn/api/p/${cityCode}?depth=2`)
            .then((res) => res.json())
            .then((data) => {
              districtSelect.disabled = false;
              data.districts.forEach((district) => {
                const option = document.createElement("option");
                option.value = district.code;
                option.textContent = district.name;
                districtSelect.appendChild(option);
              });
            });
        } else {
          districtSelect.disabled = true;
        }
      });

      // üè° Khi ch·ªçn qu·∫≠n / huy·ªán -> load ph∆∞·ªùng / x√£
      districtSelect.addEventListener("change", () => {
        const districtCode = districtSelect.value;
        wardSelect.innerHTML =
          '<option value="">-- Ch·ªçn ph∆∞·ªùng / x√£ --</option>';

        if (districtCode) {
          fetch(`https://provinces.open-api.vn/api/d/${districtCode}?depth=2`)
            .then((res) => res.json())
            .then((data) => {
              wardSelect.disabled = false;
              data.wards.forEach((ward) => {
                const option = document.createElement("option");
                option.value = ward.code;
                option.textContent = ward.name;
                wardSelect.appendChild(option);
              });
            });
        } else {
          wardSelect.disabled = true;
        }
      });
    </script>
  </body>
</html>
