<main id="target" class="container mx-auto px-4 py-8 bg-blue-50 text-blue-900">
  <h1 class="text-3xl font-bold text-blue-700 mb-6">Gi·ªè h√†ng c·ªßa b·∫°n</h1>

  <div id="cart-container" class="bg-white rounded-xl shadow p-6">
    <table class="w-full table-auto text-left">
      <thead>
        <tr class="border-b">
          <th class="py-2">S·∫£n ph·∫©m</th>
          <th class="py-2">ƒê∆°n gi√°</th>
          <th class="py-2 w-32">S·ªë l∆∞·ª£ng</th>
          <th class="py-2 text-right">Th√†nh ti·ªÅn</th>
          <th class="py-2 w-12"></th>
        </tr>
      </thead>
      <tbody id="cart-items"></tbody>
    </table>

    <div class="mt-6 flex justify-between items-center text-xl font-semibold">
      <span>T·ªïng ti·ªÅn:</span>
      <span id="total-price">0ƒë</span>
    </div>

    <button
      id="checkout-btn"
      class="mt-6 w-full bg-blue-400 hover:bg-blue-500 text-white py-3 rounded shadow"
    >
      Thanh to√°n
    </button>
  </div>
</main>

<!-- Modal Thanh To√°n -->
<div
  id="checkout-modal"
  class="fixed inset-0 bg-black/50 flex items-center justify-center hidden"
>
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
    <h2 class="text-xl font-bold text-blue-700 mb-4">Th√¥ng tin thanh to√°n</h2>
    <form id="checkout-form" class="space-y-4">
      <div>
        <label class="block mb-1 font-medium">H·ªç t√™n:</label>
        <input
          type="text"
          name="name"
          required
          class="w-full border rounded px-3 py-2"
        />
      </div>
      <div>
        <label class="block mb-1 font-medium">S·ªë ƒëi·ªán tho·∫°i:</label>
        <input
          type="text"
          name="phone"
          required
          class="w-full border rounded px-3 py-2"
        />
      </div>
      <div>
        <label class="block mb-1 font-medium">ƒê·ªãa ch·ªâ:</label>
        <textarea
          name="address"
          required
          class="w-full border rounded px-3 py-2"
        ></textarea>
      </div>
      <div class="flex justify-end space-x-3 mt-4">
        <button
          type="button"
          onclick="toggleModal(false)"
          class="px-4 py-2 border rounded text-blue-700 hover:bg-blue-100"
        >
          H·ªßy
        </button>
        <button
          type="submit"
          class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
        >
          X√°c nh·∫≠n
        </button>
      </div>
    </form>
  </div>
</div>
<script></script>
<script type="module">
  window.toggleModal = function (show) {
    const modal = document.getElementById("checkout-modal");
    modal.classList.toggle("hidden", !show);
  };
  import { fetchWithTokenRetry } from "http://127.0.0.1:5501/frontend/js/authFetch.js";

  (() => {
    let cart = [];

    const cartItemsEl = document.getElementById("cart-items");
    const totalPriceEl = document.getElementById("total-price");

    function formatMoney(n) {
      return n.toLocaleString("vi-VN") + "ƒë";
    }

    function fetchCart() {
      fetchWithTokenRetry("http://127.0.0.1:8000/api/cart")
        .then((res) => res.json())
        .then((data) => {
          cart = data.data;
          renderCart();
        })
        .catch((err) => {
          console.error("L·ªói khi t·∫£i gi·ªè h√†ng:", err);
        });
    }

    function updateQuantity(id, quantity) {
      fetchWithTokenRetry(`http://127.0.0.1:8000/api/cart/${id}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ quantity }),
      }).catch((err) => {
        console.error("L·ªói khi c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng:", err);
      });
    }

    function deleteCartItem(id) {
      fetchWithTokenRetry(`http://127.0.0.1:8000/api/cart/${id}`, {
        method: "DELETE",
      }).catch((err) => {
        console.error("L·ªói khi xo√° s·∫£n ph·∫©m:", err);
      });
    }

    function renderCart() {
      cartItemsEl.innerHTML = "";
      let total = 0;

      if (cart.length === 0) {
        cartItemsEl.innerHTML = `
      <tr>
        <td colspan="6" class="text-center py-6 text-gray-600">
          Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.<br/>
          <a href="#" onclick="loadPage('../client/home.html')" class="text-blue-500 underline">
            Ti·∫øp t·ª•c mua s·∫Øm
          </a>
        </td>
      </tr>
    `;
        totalPriceEl.textContent = "0ƒë";
        return;
      }

      cart.forEach((item, index) => {
        if (item.selected === undefined) item.selected = false;

        const itemTotal = item.price * item.quantity;
        if (item.selected) total += itemTotal;

        const row = document.createElement("tr");
        row.classList.add("border-b");

        row.innerHTML = `
      <td class="py-3 flex items-center space-x-3">
        <!-- üÜï Checkbox ch·ªçn mua -->
        <input type="checkbox" class="item-checkbox" data-index="${index}" ${
          item.selected ? "checked" : ""
        } />
        <img src="${
          item.image
        }" alt="·∫¢nh s·∫£n ph·∫©m" class="w-16 h-12 object-cover rounded" />
        <span>${item.name}</span>
      </td>
      <td class="py-3">${formatMoney(item.price)}</td>
      <td class="py-3">
        <div class="flex border rounded w-28 overflow-hidden">
          <button class="px-3 text-blue-600" data-action="decrease" data-index="${index}">-</button>
          <input type="number" min="1" value="${
            item.quantity
          }" class="w-full text-center" data-action="input" data-index="${index}" />
          <button class="px-3 text-blue-600" data-action="increase" data-index="${index}">+</button>
        </div>
      </td>
      <td class="py-3 text-right">${formatMoney(itemTotal)}</td>
      <td class="py-3 text-center">
        <button class="text-red-500" data-action="remove" data-index="${index}" title="Xo√° s·∫£n ph·∫©m">&times;</button>
      </td>
    `;

        cartItemsEl.appendChild(row);
      });

      document.querySelectorAll(".item-checkbox").forEach((checkbox) => {
        checkbox.addEventListener("change", (e) => {
          const i = Number(e.target.dataset.index);
          cart[i].selected = e.target.checked;
          renderCart();
        });
      });

      totalPriceEl.textContent = formatMoney(total);
    }

    cartItemsEl.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;

      const action = btn.getAttribute("data-action");
      const index = Number(btn.getAttribute("data-index"));
      const item = cart[index];

      if (action === "increase") {
        item.quantity++;
        updateQuantity(item.id, item.quantity);
        renderCart();
      } else if (action === "decrease") {
        if (item.quantity > 1) {
          item.quantity--;
          updateQuantity(item.id, item.quantity);
          renderCart();
        }
      } else if (action === "remove") {
        if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën xo√° s·∫£n ph·∫©m n√†y kh√¥ng?")) {
          deleteCartItem(item.id);
          cart.splice(index, 1);
          renderCart();
        }
      }
    });

    cartItemsEl.addEventListener("input", (e) => {
      const input = e.target;
      if (input.getAttribute("data-action") !== "input") return;

      const index = Number(input.getAttribute("data-index"));
      let val = parseInt(input.value);
      if (isNaN(val) || val < 1) val = 1;

      cart[index].quantity = val;
      updateQuantity(cart[index].id, val);
      renderCart();
    });

    document.getElementById("checkout-btn").addEventListener("click", () => {
      const selectedItems = cart.filter((item) => item.selected);

      if (selectedItems.length === 0) {
        alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m ƒë·ªÉ thanh to√°n!");
        return;
      }

      // L∆∞u c√°c s·∫£n ph·∫©m ƒë√£ ch·ªçn v√†o localStorage
      localStorage.setItem("checkoutItems", JSON.stringify(selectedItems));

      window.location.href = "../client/payment.html";
    });

    document.getElementById("checkout-form").addEventListener("submit", (e) => {
      e.preventDefault();

      const name = e.target.name.value.trim();
      const phone = e.target.phone.value.trim();
      const address = e.target.address.value.trim();

      if (!name || !phone || !address) {
        alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin v√† ƒëƒÉng nh·∫≠p!");
        return;
      }

      const data = {
        name: name,
        phone: phone,
        address: address,
      };

      fetchWithTokenRetry("http://localhost:8000/api/buy", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Accept: "application/json",
        },
        body: JSON.stringify(data),
      })
        .then((res) => res.json())
        .then((res) => {
          console.log("ƒê·∫∑t h√†ng th√†nh c√¥ng:", res.order_id);
          alert("‚úÖ ƒê·∫∑t h√†ng th√†nh c√¥ng!");
          loadPage("../client/home.html");

          cart = []; // Xo√° gi·ªè h√†ng
          renderCart(); // C·∫≠p nh·∫≠t l·∫°i gi·ªè
          toggleModal(false);
        })
        .catch((err) => {
          console.error("ƒê·∫∑t h√†ng l·ªói:", err);
          alert("‚ùå C√≥ l·ªói x·∫£y ra khi ƒë·∫∑t h√†ng!");
        });
    });
    document.getElementById("target")?.scrollIntoView({ behavior: "smooth" });

    fetchCart();
  })();
  // B·∫Øt ƒë·∫ßu b·∫±ng vi·ªác l·∫•y gi·ªè h√†ng t·ª´ server
</script>
