<main id="target" class=" container mx-auto px-4 py-8 bg-blue-50 text-blue-900">
  <h1 class="text-3xl font-bold text-blue-700 mb-6">Giỏ hàng của bạn</h1>

  <div id="cart-container" class="bg-white rounded-xl shadow p-6">
    <table class="w-full table-auto text-left">
      <thead>
        <tr class="border-b">
          <th class="py-2">Sản phẩm</th>
          <th class="py-2">Đơn giá</th>
          <th class="py-2 w-32">Số lượng</th>
          <th class="py-2 text-right">Thành tiền</th>
          <th class="py-2 w-12"></th>
        </tr>
      </thead>
      <tbody id="cart-items"></tbody>
    </table>

    <div class="mt-6 flex justify-between items-center text-xl font-semibold">
      <span>Tổng tiền:</span>
      <span id="total-price">0đ</span>
    </div>

    <button
      id="checkout-btn"
      class="mt-6 w-full bg-blue-400 hover:bg-blue-500 text-white py-3 rounded shadow"
    >
      Thanh toán
    </button>
  </div>
</main>

<!-- Modal Thanh Toán -->
<div
  id="checkout-modal"
  class="fixed inset-0 bg-black/50 flex items-center justify-center hidden"
>
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
    <h2 class="text-xl font-bold text-blue-700 mb-4">Thông tin thanh toán</h2>
    <form id="checkout-form" class="space-y-4">
      <div>
        <label class="block mb-1 font-medium">Họ tên:</label>
        <input
          type="text"
          name="name"
          required
          class="w-full border rounded px-3 py-2"
        />
      </div>
      <div>
        <label class="block mb-1 font-medium">Số điện thoại:</label>
        <input
          type="text"
          name="phone"
          required
          class="w-full border rounded px-3 py-2"
        />
      </div>
      <div>
        <label class="block mb-1 font-medium">Địa chỉ:</label>
        <textarea
          name="address"
          required
          class="w-full border rounded px-3 py-2"
        ></textarea>
      </div>
      <div class="flex justify-end space-x-3 mt-4">
        <button
          type="button"
          onclick="toggleModal(false)"
          class="px-4 py-2 border rounded text-blue-700 hover:bg-blue-100"
        >
          Hủy
        </button>
        <button
          type="submit"
          class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
        >
          Xác nhận
        </button>
      </div>
    </form>
  </div>
</div>
<script> 
</script>
<script type="module"> 
 function toggleModal(show) {
    const modal = document.getElementById("checkout-modal");
    modal.classList.toggle("hidden", !show);
  }
 import { fetchWithTokenRetry } from 'http://127.0.0.1:5501/frontend/js/authFetch.js';

(() => {

  let cart = [];

  const cartItemsEl = document.getElementById("cart-items");
  const totalPriceEl = document.getElementById("total-price");

  function formatMoney(n) {
    return n.toLocaleString("vi-VN") + "đ";
  }

  function fetchCart() {
 fetchWithTokenRetry("http://127.0.0.1:8000/api/cart")
      .then((res) => res.json())
      .then((data) => {
        cart = data.data;
        renderCart();
      })
      .catch((err) => {
        console.error("Lỗi khi tải giỏ hàng:", err);
      });
  }

  function updateQuantity(id, quantity) {
    fetchWithTokenRetry(`http://127.0.0.1:8000/api/cart/${id}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ quantity }),
    }).catch((err) => {
      console.error("Lỗi khi cập nhật số lượng:", err);
    });
  }

  function deleteCartItem(id) {
    fetchWithTokenRetry(`http://127.0.0.1:8000/api/cart/${id}`, {
      method: "DELETE",
    }).catch((err) => {
      console.error("Lỗi khi xoá sản phẩm:", err);
    });
  }

  function renderCart() {
    cartItemsEl.innerHTML = "";
    let total = 0;

     if (cart.length === 0) {
    cartItemsEl.innerHTML = `
      <tr>
        <td colspan="5" class="text-center py-6 text-gray-600">
           Giỏ hàng của bạn đang trống.<br/>
          <a href="#"               onclick="loadPage('../client/home.html')"
 class="text-blue-500 underline">Tiếp tục mua sắm</a>
        </td>
      </tr>
    `;
    totalPriceEl.textContent = "0đ";
    return;
  }

    cart.forEach((item, index) => {
      const itemTotal = item.price * item.quantity;
      total += itemTotal;

      const row = document.createElement("tr");
      row.classList.add("border-b");

      row.innerHTML = `
        <td class="py-3 flex items-center space-x-3">
          <img src="${
            item.image
          }" alt="Ảnh sản phẩm" class="w-16 h-12 object-cover rounded" />
          <span>${item.name}</span>
        </td>
        <td class="py-3">${formatMoney(item.price)}</td>
        <td class="py-3">
          <div class="flex border rounded w-28 overflow-hidden">
            <button class="px-3 text-blue-600" data-action="decrease" data-index="${index}">-</button>
            <input type="number" min="1" value="${
              item.quantity
            }" class="w-full text-center" data-action="input" data-index="${index}" />
            <button class="px-3 text-blue-600" data-action="increase" data-index="${index}">+</button>
          </div>
        </td>
        <td class="py-3 text-right">${formatMoney(itemTotal)}</td>
        <td class="py-3 text-center">
          <button class="text-red-500" data-action="remove" data-index="${index}" title="Xoá sản phẩm">&times;</button>
        </td>
      `;

      cartItemsEl.appendChild(row);
    });

    totalPriceEl.textContent = formatMoney(total);
  }

  cartItemsEl.addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if (!btn) return;

    const action = btn.getAttribute("data-action");
    const index = Number(btn.getAttribute("data-index"));
    const item = cart[index];

    if (action === "increase") {
      item.quantity++;
      updateQuantity(item.id, item.quantity);
      renderCart();
    } else if (action === "decrease") {
      if (item.quantity > 1) {
        item.quantity--;
        updateQuantity(item.id, item.quantity);
        renderCart();
      }
    } else if (action === "remove") {
      if (confirm("Bạn có chắc muốn xoá sản phẩm này không?")) {
        deleteCartItem(item.id);
        cart.splice(index, 1);
        renderCart();
      }
    }
  });

  cartItemsEl.addEventListener("input", (e) => {
    const input = e.target;
    if (input.getAttribute("data-action") !== "input") return;

    const index = Number(input.getAttribute("data-index"));
    let val = parseInt(input.value);
    if (isNaN(val) || val < 1) val = 1;

    cart[index].quantity = val;
    updateQuantity(cart[index].id, val);
    renderCart();
  });

  document.getElementById("checkout-btn").addEventListener("click", () => {
    if (cart.length === 0) {
      alert("Giỏ hàng trống!");
      return;
    }
    toggleModal(true);
  });


  

  document.getElementById("checkout-form").addEventListener("submit", (e) => {
  e.preventDefault();

  const name = e.target.name.value.trim();
  const phone = e.target.phone.value.trim();
  const address = e.target.address.value.trim();

  if (!name || !phone || !address ) {
    alert("Vui lòng điền đầy đủ thông tin và đăng nhập!");
    return;
  }

  const data = {

    name: name,
    phone: phone,
    address: address,
   
  };

  fetchWithTokenRetry("http://localhost:8000/api/buy", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Accept: "application/json",
    },
    body: JSON.stringify(data),
  })
    .then((res) => res.json())
    .then((res) => {
      console.log("Đặt hàng thành công:", res.order_id);
      alert("✅ Đặt hàng thành công!");      
       loadPage('../client/home.html');

      cart = []; // Xoá giỏ hàng
      renderCart(); // Cập nhật lại giỏ
       toggleModal(false);
    })
    .catch((err) => {
      console.error("Đặt hàng lỗi:", err);
      alert("❌ Có lỗi xảy ra khi đặt hàng!");
    });
});
       document.getElementById('target')?.scrollIntoView({ behavior: 'smooth' });

  fetchCart();
  })();
  // Bắt đầu bằng việc lấy giỏ hàng từ server
</script>
