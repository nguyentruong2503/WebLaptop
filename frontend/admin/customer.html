<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<div class="container mx-auto py-8">
  <h2 class="mb-6 text-2xl font-bold text-primary-700">Quản lý khách hàng</h2>
  <!-- Nút Thêm mới -->
  <button id="show-add-form" class="mb-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-medium">
    Thêm khách hàng
  </button>
  <div class="overflow-x-auto bg-white rounded-lg shadow border">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-blue-100">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">ID</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">Tên</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">Email</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">SĐT</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">Địa chỉ</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">Năm sinh</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">Quyền</th>
          <th class="px-6 py-3 text-center text-xs font-medium text-blue-700 uppercase tracking-wider">Hành động</th>
        </tr>
      </thead>
      <tbody id="customer-table" class="bg-white divide-y divide-gray-200">
        <!-- Dữ liệu khách hàng sẽ được render ở đây bằng JS -->
      </tbody>
    </table>
  </div>
</div>

<!-- Modal Form -->
<div id="userModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-lg mx-4"> 
    <form id="user-form" class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h5 class="text-lg font-semibold" id="userModalLabel">Thêm khách hàng</h5>
        <button type="button" id="cancel-btn" class="text-gray-400 hover:text-gray-700 text-2xl font-bold">&times;</button>
      </div>
      <input type="hidden" id="user-id">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> 
        <div>
          <label class="block text-sm font-medium mb-1">Tên</label>
          <input id="user-name" type="text" class="w-full border rounded px-3 py-2" required>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Email</label>
          <input id="user-email" type="email" class="w-full border rounded px-3 py-2" required>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Mật khẩu</label>
          <input id="user-password" type="password" class="w-full border rounded px-3 py-2" minlength="6">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Số điện thoại</label>
          <input id="user-phone" type="text" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Địa chỉ</label>
          <input id="user-address" type="text" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Năm sinh</label>
          <input id="user-yearOfbirth" type="number" min="1900" max="2100" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Quyền</label>
          <select id="user-role" class="w-full border rounded px-3 py-2">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button type="button" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded" id="close-modal">Hủy</button>
        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded" id="submit-btn">Thêm mới</button>
      </div>
    </form>
  </div>
</div>
<script type="module">
import { fetchWithTokenRetry } from 'http://127.0.0.1:5501/frontend/js/authFetch.js';

var userModal = document.getElementById('userModal');
var showAddBtn = document.getElementById('show-add-form');
var closeModalBtn = document.getElementById('close-modal');
var cancelBtn = document.getElementById('cancel-btn');

showAddBtn.onclick = function() {
  document.getElementById('user-form').reset();
  document.getElementById('user-id').value = '';
  document.getElementById('submit-btn').textContent = 'Thêm mới';
  document.getElementById('userModalLabel').textContent = 'Thêm khách hàng';
  userModal.classList.remove('hidden');
};
closeModalBtn.onclick = cancelBtn.onclick = function() {
  userModal.classList.add('hidden');
};

function deleteUser(id) {
  if (confirm('Bạn có chắc chắn muốn xóa user này?')) {
    fetchWithTokenRetry(`http://127.0.0.1:8000/api/users/${id}`, {
      method: 'DELETE'
    })
    .then(res => res.json())
    .then(data => {
      alert(data.message || 'Đã xóa!');
      loadUsers();
    })
    .catch(() => alert('Xóa thất bại!'));
  }
}

function editUser(user) {
  document.getElementById('user-id').value = user.id;
  document.getElementById('user-name').value = user.name;
  document.getElementById('user-email').value = user.email;
  document.getElementById('user-role').value = user.role;
  document.getElementById('user-password').value = '';
  document.getElementById('user-phone').value = user.phone || '';
  document.getElementById('user-address').value = user.address || '';
  document.getElementById('user-yearOfbirth').value = user.yearOfbirth || '';
  document.getElementById('submit-btn').textContent = 'Cập nhật';
  document.getElementById('userModalLabel').textContent = 'Cập nhật khách hàng';
  userModal.classList.remove('hidden');
}

document.getElementById('user-form').onsubmit = function(e) {
  e.preventDefault();
  const id = document.getElementById('user-id').value;
  const name = document.getElementById('user-name').value;
  const email = document.getElementById('user-email').value;
  const password = document.getElementById('user-password').value;
  const role = document.getElementById('user-role').value;
  const phone = document.getElementById('user-phone').value;
  const address = document.getElementById('user-address').value;
  const yearOfbirth = document.getElementById('user-yearOfbirth').value;

  const method = id ? 'PUT' : 'POST';
  const url = id ? `http://127.0.0.1:8000/api/users/${id}` : 'http://127.0.0.1:8000/api/users';
  const body = { name, email, role, phone, address, yearOfbirth };
  if (password) body.password = password;

  fetchWithTokenRetry(url, {
    method: method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  })
  .then(res => res.json())
  .then(data => {
    if (data.errors) {
      alert(Object.values(data.errors).join('\n'));
    } else {
      alert(id ? 'Cập nhật thành công!' : 'Thêm mới thành công!');
      loadUsers();
      userModal.classList.add('hidden');
    }
  })
  .catch(() => alert('Có lỗi xảy ra!'));
};

function loadUsers() {
  fetchWithTokenRetry('http://127.0.0.1:8000/api/users')
    .then(res => res.json())
    .then(data => {
      const tbody = document.getElementById('customer-table');
      tbody.innerHTML = '';
      data.forEach(user => {
        tbody.innerHTML += `
          <tr>
            <td class="px-6 py-4 whitespace-nowrap">${user.id}</td>
            <td class="px-6 py-4 whitespace-nowrap">${user.name}</td>
            <td class="px-6 py-4 whitespace-nowrap">${user.email}</td>
            <td class="px-6 py-4 whitespace-nowrap">${user.phone || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap">${user.address || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap">${user.yearOfbirth || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="inline-block px-2 py-1 rounded text-xs font-semibold ${user.role === 'admin' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                ${user.role}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-center">
              <button onclick='editUser(${JSON.stringify(user)})' class="bg-yellow-400 hover:bg-yellow-500 text-white px-3 py-1 rounded mr-2 text-xs">Sửa</button>
              <button onclick="deleteUser(${user.id})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs">Xóa</button>
            </td>
          </tr>
        `;
      });
    });
}

// Tải danh sách user khi trang load
loadUsers();

window.editUser = editUser;
window.deleteUser = deleteUser;
</script>