<div id="loginBox" class="w-full max-w-md bg-gray-800 bg-opacity-90 rounded-lg shadow-lg p-8 relative z-10">
    <h2 class="text-2xl font-bold text-center text-blue-400 mb-6">ƒêƒÉng nh·∫≠p t√†i kho·∫£n</h2>
    <form id="loginForm">
        <div class="mb-4">
            <label class="block text-sm font-medium mb-1 text-gray-200">Email</label>
            <input type="email" id="login-email" class="w-full border border-gray-600 rounded px-3 py-2 bg-gray-700 text-gray-100" required placeholder="Nh·∫≠p email...">
        </div>
        <div class="mb-6">
            <label class="block text-sm font-medium mb-1 text-gray-200">M·∫≠t kh·∫©u</label>
            <input type="password" id="login-password" class="w-full border border-gray-600 rounded px-3 py-2 bg-gray-700 text-gray-100" required placeholder="Nh·∫≠p m·∫≠t kh·∫©u...">
        </div>
        <button type="submit" class="w-full bg-gradient-to-r from-blue-700 via-indigo-700 to-gray-700 text-white py-2 rounded font-semibold shadow-md btn-animate">ƒêƒÉng nh·∫≠p</button>
    </form>
    <div class="mt-4 text-center text-sm text-gray-300">
        Ch∆∞a c√≥ t√†i kho·∫£n?
        <button id="show-register" class="text-blue-400 hover:underline focus:outline-none">ƒêƒÉng k√Ω ngay</button>
    </div>
</div>

<script type="module">
import { fetchWithTokenRetry } from 'http://127.0.0.1:5501/frontend/js/authFetch.js';

document.getElementById('show-register').onclick = function() {
    loadPage('auth/register.html');
};

document.getElementById('loginForm').onsubmit = async function (e) {
  e.preventDefault();
  const email = document.getElementById('login-email').value;
  const password = document.getElementById('login-password').value;

  try {
    const res = await fetch('http://127.0.0.1:8000/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });

    const data = await res.json();

    if (res.ok && data.access_token) {
      // üß† L∆∞u token v√†o localStorage
      localStorage.setItem('token', data.access_token);

      // ‚úÖ G·ªçi API l·∫•y th√¥ng tin user ƒë·ªÉ ki·ªÉm tra role
      const profileRes = await fetchWithTokenRetry('http://127.0.0.1:8000/api/user');
      const profileData = await profileRes.json();

      if (profileData.role === 'admin') {
        window.location.href = '/frontend/layouts/admin-layout.html';
      } else if (profileData.role === 'user') {
        window.location.href = '/frontend/layouts/cliend-layout.html';
      } else {
        alert('Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c quy·ªÅn truy c·∫≠p!');
      }

    } else {
      alert('ƒêƒÉng nh·∫≠p th·∫•t b·∫°i! Vui l√≤ng ki·ªÉm tra email/m·∫≠t kh·∫©u.');
    }
  } catch (err) {
    console.error(err);
    alert('L·ªói k·∫øt n·ªëi ƒë·∫øn server!');
  }
};
</script>
